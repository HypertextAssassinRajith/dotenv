<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit .env</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Flowbite CSS CDN -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans">
  <!-- Login Modal -->
  <div id="loginOverlay" class="fixed inset-0 bg-gray-100 bg-opacity-95 flex items-center justify-center z-50">
    <div class="w-full max-w-sm bg-white rounded-lg shadow-lg p-8">
      <h3 class="text-xl font-semibold text-gray-800 text-center mb-4">Login</h3>
      <button id="googleLoginBtn" onclick="googleLogin()" type="button"
        class="flex items-center justify-center gap-2 w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2 font-medium transition mb-3">
        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/google/google-original.svg" alt="Google" class="w-5 h-5"> Login with Google
      </button>
      <div class="text-red-500 text-center min-h-[1.5em] text-base" id="loginError"></div>
    </div>
  </div>
  <!-- Main Card -->
  <div class="w-full max-w-lg bg-white rounded-lg shadow-lg p-8" id="mainContainer" style="display:none;">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Edit .env File</h2>
    <form class="mb-4">
      <label class="block text-base text-gray-700 mb-2 font-medium" for="projectSelect">Project name:</label>
      <div class="flex gap-2">
        <select id="projectSelect" onchange="onProjectChange()" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-2 focus:ring-blue-500"></select>
        <input id="project" value="default" style="display:none;" />
        <button type="button" onclick="loadEnv()" class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition">Load</button>
        <button type="button" onclick="newProject()" title="Create new .env file" class="px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition">New</button>
        <button type="button" onclick="deleteProject()" title="Delete selected .env file" class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition">Delete</button>
      </div>
    </form>
    <textarea id="envContent" class="w-full h-56 resize-y font-mono text-base border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 focus:ring-2 focus:ring-blue-500 mb-4"></textarea>
    <div class="flex items-center gap-2">
      <button type="button" onclick="saveEnv()" class="bg-blue-500 hover:bg-blue-600 text-white rounded-lg px-4 py-2 font-medium transition">Save</button>
      <button type="button" onclick="copyEnv()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg px-4 py-2 font-medium transition">Copy to Clipboard</button>
      <button type="button" onclick="logout()" class="ml-auto bg-red-500 hover:bg-red-600 text-white rounded-lg px-4 py-2 font-medium transition">Logout</button>
      <span id="msg" class="ml-2 text-green-600 font-medium text-base"></span>
    </div>
  </div>
  <!-- Toast/Alert -->
  <div id="toast" class="fixed left-1/2 bottom-10 transform -translate-x-1/2 z-50 w-fit"></div>
  <!-- Flowbite JS CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
  <script>
    // --- Google Login logic ---
    async function checkAuth() {
      try {
        const res = await fetch('/api/user');
        const data = await res.json();
        if (data.authenticated) {
          document.getElementById('loginOverlay').style.display = 'none';
          document.getElementById('mainContainer').style.display = '';
          fetchProjects();
        } else {
          document.getElementById('loginOverlay').style.display = '';
          document.getElementById('mainContainer').style.display = 'none';
        }
      } catch (err) {
        showToast('Failed to check authentication');
      }
    }
    function googleLogin() {
      window.location.href = '/auth/google';
    }
    async function logout() {
      await fetch('/api/logout');
      document.getElementById('mainContainer').style.display = 'none';
      document.getElementById('loginOverlay').style.display = '';
    }
    async function fetchProjects(selected) {
      const res = await fetch('/api/env');
      const projects = await res.json();
      const select = document.getElementById('projectSelect');
      select.innerHTML = '';
      projects.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        select.appendChild(opt);
      });
      if (projects.length) {
        select.value = selected && projects.includes(selected) ? selected : projects[0];
        document.getElementById('project').value = select.value;
        loadEnv();
      } else {
        document.getElementById('envContent').value = '';
        document.getElementById('project').value = '';
      }
    }
    function onProjectChange() {
      document.getElementById('project').value = document.getElementById('projectSelect').value;
      loadEnv();
    }
    async function loadEnv() {
      const project = document.getElementById('project').value;
      const res = await fetch(`/api/env/${project}`);
      if (res.ok) {
        document.getElementById('envContent').value = await res.text();
      } else {
        document.getElementById('envContent').value = '';
        showToast('Failed to load .env file');
      }
    }
    function showToast(msg, type = 'error') {
      const toast = document.getElementById('toast');
      toast.innerHTML = `
        <div class="flex items-center p-4 mb-4 text-sm ${type === 'success' ? 'text-green-800 bg-green-100' : 'text-red-800 bg-red-100'} rounded-lg shadow" role="alert">
          <svg aria-hidden="true" class="flex-shrink-0 inline w-5 h-5 mr-3 ${type === 'success' ? 'text-green-500' : 'text-red-500'}" fill="currentColor" viewBox="0 0 20 20"><path d="${type === 'success'
            ? 'M16.707 5.293a1 1 0 00-1.414 0L9 11.586 6.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l7-7a1 1 0 000-1.414z'
            : 'M18 10A8 8 0 11 2 10a8 8 0 0116 0zm-7-4a1 1 0 10-2 0v4a1 1 0 002 0V6zm-1 8a1 1 0 100-2 1 1 0 000 2z'}"></path></svg>
          <span>${msg}</span>
        </div>`;
      toast.classList.add('opacity-100');
      setTimeout(() => {
        toast.innerHTML = '';
        toast.classList.remove('opacity-100');
      }, 2000);
    }
    async function saveEnv() {
      const project = document.getElementById('project').value;
      const content = document.getElementById('envContent').value;
      const res = await fetch(`/api/env/${project}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content })
      });
      if (res.ok) {
        document.getElementById('msg').textContent = 'Saved!';
        setTimeout(() => document.getElementById('msg').textContent = '', 1000);
      } else {
        showToast('Failed to save .env file');
      }
    }
    function copyEnv() {
      const textarea = document.getElementById('envContent');
      textarea.select();
      document.execCommand('copy');
      document.getElementById('msg').textContent = 'Copied!';
      setTimeout(() => document.getElementById('msg').textContent = '', 1000);
    }
    // Add this function to handle login errors (e.g., after redirect from Google with error param)
    function checkLoginError() {
      const params = new URLSearchParams(window.location.search);
      if (params.has('error')) {
        const msg = params.get('error') === 'access_denied'
          ? 'Google login was denied.'
          : 'Login failed. Please try again.';
        document.getElementById('loginError').textContent = msg;
        showToast(msg);
        // Optionally, remove error param from URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }
    async function newProject() {
      const name = prompt('Enter new project name (no spaces, e.g. "my-app"):');
      if (!name) return;
      if (!/^[\w.-]+$/.test(name)) {
        showToast('Invalid name. Use letters, numbers, dash, dot, or underscore.');
        return;
      }
      // Check if already exists
      const select = document.getElementById('projectSelect');
      for (let i = 0; i < select.options.length; i++) {
        if (select.options[i].value === name) {
          showToast('Project already exists.');
          return;
        }
      }
      // Create new file
      const res = await fetch(`/api/env/${encodeURIComponent(name)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: '' })
      });
      if (res.ok) {
        showToast('Created!', 'success');
        fetchProjects(name);
      } else {
        showToast('Failed to create file');
      }
    }
    async function deleteProject() {
      const project = document.getElementById('project').value;
      if (!project) return;
      if (!confirm(`Delete "${project}"? This cannot be undone.`)) return;
      const res = await fetch(`/api/env/${encodeURIComponent(project)}`, { method: 'DELETE' });
      if (res.ok) {
        showToast('Deleted!', 'success');
        fetchProjects();
      } else {
        showToast('Failed to delete file');
      }
    }
    window.onload = function() {
      checkAuth();
      checkLoginError();
    };
  </script>
</body>
</html>
