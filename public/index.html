<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit .env</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f4f6fb;
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 2.5em 2em 2em 2em;
      max-width: 480px;
      width: 100%;
    }
    h2 {
      margin-top: 0;
      font-weight: 600;
      color: #222;
      letter-spacing: 0.5px;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: 0.5em;
      font-size: 1em;
      margin-bottom: 1em;
      color: #444;
    }
    select, input[type="text"], textarea {
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 0.5em 0.75em;
      font-size: 1em;
      background: #f9fafb;
      transition: border 0.2s;
      margin-bottom: 0.5em;
    }
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #6366f1;
      background: #fff;
    }
    textarea {
      width: 100%;
      height: 220px;
      resize: vertical;
      font-family: 'Fira Mono', 'Consolas', monospace;
      font-size: 1em;
      margin-bottom: 1em;
    }
    button {
      background: #6366f1;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.6em 1.2em;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      margin-right: 0.5em;
      transition: background 0.2s;
      box-shadow: 0 2px 8px rgba(99,102,241,0.08);
    }
    button:hover, button:focus {
      background: #4f46e5;
    }
    #msg {
      margin-left: 0.5em;
      color: #10b981;
      font-weight: 500;
      font-size: 1em;
      vertical-align: middle;
    }
    .login-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(244,246,251,0.98);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .login-box {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.10);
      padding: 2em 2em 1.5em 2em;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 1em;
    }
    .login-box h3 {
      margin: 0 0 0.5em 0;
      font-weight: 600;
      color: #222;
      text-align: center;
    }
    .login-box input[type="password"] {
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 0.5em 0.75em;
      font-size: 1em;
      background: #f9fafb;
      margin-bottom: 0.5em;
    }
    .login-box button {
      background: #6366f1;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.6em 1.2em;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .login-box button:hover, .login-box button:focus {
      background: #4f46e5;
    }
    .login-error {
      color: #ef4444;
      font-size: 0.95em;
      text-align: center;
      min-height: 1.5em;
    }
    /* Toast styles */
    #toast {
      visibility: hidden;
      min-width: 200px;
      background: #ef4444;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 0.8em 1.2em;
      position: fixed;
      left: 50%;
      bottom: 40px;
      transform: translateX(-50%);
      z-index: 2000;
      font-size: 1em;
      opacity: 0;
      transition: opacity 0.3s, visibility 0.3s;
      box-shadow: 0 2px 12px rgba(239,68,68,0.12);
    }
    #toast.show {
      visibility: visible;
      opacity: 1;
    }
    #toast.success {
      background: #10b981;
    }
    @media (max-width: 600px) {
      .container {
        padding: 1em;
        max-width: 100vw;
      }
      textarea {
        height: 120px;
      }
    }
  </style>
</head>
<body>
  <div id="loginOverlay" class="login-overlay">
    <div class="login-box" id="loginBox">
      <h3>Login</h3>
      <button id="googleLoginBtn" onclick="googleLogin()" type="button" style="display:flex;align-items:center;justify-content:center;gap:0.5em;">
        <img src="https://www.citypng.com/public/uploads/preview/google-logo-icon-gsuite-hd-701751694791470gzbayltphh.png" alt="Google" style="width:20px;height:20px;"> Login with Google
      </button>
      <div class="login-error" id="loginError"></div>
    </div>
  </div>
  <div class="container" id="mainContainer" style="display:none;">
    <h2>Edit .env File</h2>
    <label>
      Project name:
      <div style="display: flex; gap: 0.5em;">
        <select id="projectSelect" onchange="onProjectChange()" style="flex:1"></select>
        <input id="project" value="default" style="display:none;" />
        <button onclick="loadEnv()" style="padding: 0.5em 1em;">Load</button>
      </div>
    </label>
    <textarea id="envContent"></textarea>
    <div style="display: flex; align-items: center; gap: 0.5em;">
      <button onclick="saveEnv()">Save</button>
      <button onclick="copyEnv()">Copy to Clipboard</button>
      <button onclick="logout()" style="margin-left:auto;background:#ef4444;">Logout</button>
      <span id="msg"></span>
    </div>
  </div>
  <div id="toast"></div>
  <script>
    // --- Google Login logic ---
    async function checkAuth() {
      try {
        const res = await fetch('/api/user');
        const data = await res.json();
        if (data.authenticated) {
          document.getElementById('loginOverlay').style.display = 'none';
          document.getElementById('mainContainer').style.display = '';
          fetchProjects();
        } else {
          document.getElementById('loginOverlay').style.display = '';
          document.getElementById('mainContainer').style.display = 'none';
        }
      } catch (err) {
        showToast('Failed to check authentication');
      }
    }
    function googleLogin() {
      window.location.href = '/auth/google';
    }
    async function logout() {
      await fetch('/api/logout');
      document.getElementById('mainContainer').style.display = 'none';
      document.getElementById('loginOverlay').style.display = '';
    }
    async function fetchProjects() {
      const res = await fetch('/api/env');
      const projects = await res.json();
      const select = document.getElementById('projectSelect');
      select.innerHTML = '';
      projects.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        select.appendChild(opt);
      });
      if (projects.length) {
        select.value = projects[0];
        document.getElementById('project').value = projects[0]; // Set input value
        loadEnv();
      }
    }
    function onProjectChange() {
      document.getElementById('project').value = document.getElementById('projectSelect').value;
      loadEnv();
    }
    async function loadEnv() {
      const project = document.getElementById('project').value;
      const res = await fetch(`/api/env/${project}`);
      if (res.ok) {
        document.getElementById('envContent').value = await res.text();
      } else {
        document.getElementById('envContent').value = '';
        showToast('Failed to load .env file');
      }
    }
    function showToast(msg, type = 'error') {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'show' + (type === 'success' ? ' success' : '');
      setTimeout(() => {
        toast.className = toast.className.replace('show', '');
      }, 2000);
    }
    async function saveEnv() {
      const project = document.getElementById('project').value;
      const content = document.getElementById('envContent').value;
      const res = await fetch(`/api/env/${project}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content })
      });
      if (res.ok) {
        document.getElementById('msg').textContent = 'Saved!';
        setTimeout(() => document.getElementById('msg').textContent = '', 1000);
      } else {
        showToast('Failed to save .env file');
      }
    }
    function copyEnv() {
      const textarea = document.getElementById('envContent');
      textarea.select();
      document.execCommand('copy');
      document.getElementById('msg').textContent = 'Copied!';
      setTimeout(() => document.getElementById('msg').textContent = '', 1000);
    }
    // Add this function to handle login errors (e.g., after redirect from Google with error param)
    function checkLoginError() {
      const params = new URLSearchParams(window.location.search);
      if (params.has('error')) {
        const msg = params.get('error') === 'access_denied'
          ? 'Google login was denied.'
          : 'Login failed. Please try again.';
        document.getElementById('loginError').textContent = msg;
        showToast(msg);
        // Optionally, remove error param from URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }
    window.onload = function() {
      checkAuth();
      checkLoginError();
    };
  </script>
</body>
</html>
